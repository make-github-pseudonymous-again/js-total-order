<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/index.js | total-order</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-style.css"><script src="./inject/script/0-header.js"></script><meta name="description" content="A total order for all JavaScript values"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="total-order"><meta property="twitter:description" content="A total order for all JavaScript values"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/total-order/any"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepCompare">deepCompare</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import assert from &apos;assert&apos;;
import {prop} from &apos;@total-order/key&apos;;
import {quasilexicographical} from &apos;@total-order/lex&apos;;
import {increasing as compare} from &apos;@total-order/primitive&apos;;
import {MemoryEfficientPairs as Pairs} from &apos;@collection-abstraction/pairs&apos;;

const deepCompare = (a, b) =&gt; {
	if (a === b) return 0;

	const left = [[a]];
	const right = [[b]];
	const pos = [0];
	const pendingOrChecked = Pairs.from([]);

	while (left.length &gt; 0) {
		assert(left.length === right.length);
		assert(left.length === pos.length);

		const last = left.length - 1;
		const array_a = left[last];
		const array_b = right[last];
		const i = pos[last];

		assert(array_a.length === array_b.length);
		assert(i &gt;= 0 &amp;&amp; i &lt;= array_a.length);
		if (i === array_a.length) {
			left.pop();
			right.pop();
			pos.pop();
			continue;
		}

		++pos[last];

		const _a = array_a[i];
		const _b = array_b[i];
		const typeof_a = typeof _a;
		const typeof_b = typeof _b;

		const delta_type = compare(typeof_a, typeof_b);
		if (delta_type !== 0) return delta_type;

		if (typeof_a !== &apos;object&apos;) {
			const delta_primitive = comparePrimitives(typeof_a, _a, _b);
			if (delta_primitive !== 0) return delta_primitive;
			continue;
		}

		assert(typeof_a === &apos;object&apos;);

		if (_a === null) {
			if (_b === null) continue;
			return -1;
		}

		if (_b === null) {
			return 1;
		}

		if (pendingOrChecked.has([_a, _b])) continue;
		pendingOrChecked.add([_a, _b]);
		pendingOrChecked.add([_b, _a]);

		const constructor_a = a.constructor;
		const constructor_b = b.constructor;

		if (constructor_a !== constructor_b)
			return compare(constructor_a.name, constructor_b.name);

		// TODO typed arrays
		// TODO other built-ins, see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects
		switch (constructor_a) {
			case RegExp:
				const delta_regexp = compare(_a.toString(), _b.toString());
				if (delta_regexp !== 0) return delta_regexp;
				continue;
			case Date:
				const delta_date = compare(_a.getTime(), _b.getTime());
				if (delta_date !== 0) return delta_date;
				continue;
			case Array:
				if (_a.length !== _b.length) return _a.length - _b.length;
				left.push(_a);
				right.push(_b);
				pos.push(0);
				continue;
			case Object:
				const keys_a = Object.keys(_a).sort(compare);
				const keys_b = Object.keys(_b).sort(compare);

				const delta_keys = compareStringArrays(keys_a, keys_b);
				if (delta_keys !== 0) return delta_keys;

				const values_a = Object.entries(_a)
					.sort(compareEntries)
					.map((x) =&gt; x[1]);
				const values_b = Object.entries(_b)
					.sort(compareEntries)
					.map((x) =&gt; x[1]);

				left.push(values_a);
				right.push(values_b);
				pos.push(0);
				continue;
			default:
				throw new Error(
					`deepCompare: unhandled constructor &apos;${constructor_a.name}&apos;`,
				);
		}
	}

	return 0;
};

const comparePrimitives = (kind, _a, _b) =&gt; {
	assert(kind !== &apos;object&apos;);
	switch (kind) {
		case &apos;number&apos;:
			if (Number.isNaN(_a)) {
				if (Number.isNaN(_b)) return 0;
				return 1;
			}

			if (Number.isNaN(_b)) {
				return -1;
			}

		case &apos;boolean&apos;:
		case &apos;string&apos;:
		case &apos;bigint&apos;:
			return compare(_a, _b);
		case &apos;function&apos;:
			return compare(_a.toString(), _b.toString());
		default:
			throw new Error(`deepCompare: unhandled primitive type &apos;${kind}&apos;`);
	}
};

const compareEntries = prop(compare, 0);
// Const compareArrays = quasilexicographical(deepCompare);
const compareStringArrays = quasilexicographical(compare);
// Const compareObjects = (a, b) =&gt; {
// const keys_a = Object.keys(a).sort(compare);
// const keys_b = Object.keys(b).sort(compare);

// const delta_keys = compareStringArrays(keys_a, keys_b);
// if (delta_keys !== 0) return delta_keys;

// const values_a = Object.entries(a)
// .sort(compareEntries)
// .map((x) =&gt; x[1]);
// const values_b = Object.entries(b)
// .sort(compareEntries)
// .map((x) =&gt; x[1]);

// return compareArrays(values_a, values_b);
// };

export default deepCompare;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
